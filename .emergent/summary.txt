<analysis>**original_problem_statement:** The user wants to build a comprehensive web application for their wellness business, Mother Natural: The Healing Lab.

**PRODUCT REQUIREMENTS:**
-   **Core Features:**
    -   E-commerce shop for products with variants, stock count, and automatic population on the home page.
    -   Appointment booking system.
    -   Enrollment for wellness classes with enhanced options (instructor, date, package deals, add-ons, multiple days).
    -   A booking system for retreats with add-ons.
    -   A private social platform/community for clients.
    -   A fundraiser section with an admin approval workflow.
    -   A contract signing system with editable templates.
    -   An emergency Crisis Support feature.
    -   File-based image uploads with cropping for all content types.
    -   User dashboard with profile picture uploads.
    -   Ability to hide content (products, classes, etc.) from public view (draft/published mode).
-   **Admin Panel:** A comprehensive dashboard to manage all app aspects, including analytics, user management, and tax settings.
-   **Payments:** Integration with Square, including configurable tax calculation.
-   **Email:** Integration with an email service (Resend) for communication.
-   **Design:** A calming UI that preserves text formatting. The app icon and name should reflect the brand on mobile home screens.

**User's preferred language**: English

**what currently exists?**
A full-stack application with a React frontend and FastAPI backend using MongoDB. All major features from the product requirements have been implemented.
-   **Backend:** Supports JWT auth, file uploads, and CRUD operations for all models, including new features like stock count, hidden/published status, add-ons for classes/retreats, configurable tax settings, and contract template management.
-   **Frontend:** The UI has been enhanced across the board. The admin panel now includes management for new features like stock, hidden status, class add-ons, tax settings, and contract templates. The public-facing pages (Shop, Classes, Home) have been updated to display this new information (e.g., stock levels, new class details, products from API). Image uploads now use a cropper. The customer dashboard supports profile picture uploads.

**Last working item**:
-   **Last item agent was working:** The user requested to add a feature for creating, editing, and deleting contract templates in the admin panel. The agent implemented this by creating backend CRUD endpoints for contract templates and overwriting the existing  component with a new version that supports full template management.
-   **Status:** COMPLETED
-   **Agent Testing Done:** Y
-   **Which testing method agent to use?** The agent verified the new UI via a screenshot, which confirmed the template list, Add button, and signed contracts list were all displaying correctly. The API was also tested. The Add dialog was not shown in the final screenshot due to a session timeout.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: Resend API Key is Invalid (P1)**
    -   **Attempted fixes:** The agent confirmed the backend code is correct but received an API key is invalid error when making a test call.
    -   **Next debug checklist:**
        1.  Inform the user that the  in  is invalid.
        2.  Ask the user to provide a new, valid API key from their Resend account.
        3.  Update the  file with the new key and re-run the test.
    -   **Why fix this issue and what will be achieved with the fix?** Enables the application to send emails (e.g., receipts, notifications) from the user's branded domain, which is crucial for business operations.
    -   **Status:** BLOCKED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on other issue:** Awaiting a valid API key from the user.
-   **Issue 2: User Confusion on Stock Count in Edit Form (P2)**
    -   **Attempted fixes:** The user stated the stock count field was missing from the Edit Product dialog. The agent investigated, confirmed the field exists in the code (, lines 513-517), and provided a screenshot showing it. The issue seems to be user-side confusion or a UI rendering bug under specific conditions not reproduced by the agent.
    -   **Next debug checklist:**
        1.  Engage the user to confirm if they can now see the Stock Count field in the Edit Product dialog.
        2.  If they still can't see it, ask for a screenshot from their end.
        3.  Offer to move the field to a different location in the form (e.g., after size variants) if it improves visibility.
    -   **Why fix this issue and what will be achieved with the fix?** Resolves user friction and ensures they can fully manage product stock.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on other issue:** None.

**In progress Task List**:
-   There are no tasks currently in progress.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **P1: Integrate Add-Ons into Checkout Flow:** The backend and admin UI support creating add-ons for classes and retreats, but the public-facing enrollment/booking process does not yet allow users to select and pay for them. This needs to be added to the  and  payment dialogs.
    -   **P1: Full UI Verification of Recent Features:** Due to persistent session timeouts in the preview environment, several newly implemented features were only verified via backend API calls or partial screenshots. A full end-to-end UI verification is needed for:
        -   Image cropping on all admin forms (Products, Classes, Retreats, Fundraisers, Services).
        -   Customer profile picture upload and display on the .
        -   The Add/Edit dialogs for Add-ons and Hidden status on  and .
-   **Future Tasks:**
    -   **P2: Auto-reduce stock on purchase:** The stock count is currently manual. It should decrement automatically when an order is successfully placed.
    -   **P2: Low stock email notifications:** Send an automated email to the admin when a product's stock drops below a certain threshold.
    -   **P2: Native Mobile App / Push Notifications:** A long-term goal for deeper user engagement.
    -   **P2: Advanced Reporting Exports:** Enhance the analytics dashboard with data export functionality (e.g., to CSV).

**Completed work in this session**
-   **Bug Fixes:**
    -   Services are now displayed on the public-facing Appointments page (fixed loading from API instead of ).
    -   Corrected the mobile home screen app icon and name by creating  and updating .
    -   Updated the home screen icon again with a new user-provided image.
    -   Fixed a bug where a service had a  id, causing rendering errors.
    -   Preserved whitespace/formatting in descriptions across all relevant pages (, , , ).
-   **Feature Enhancements:**
    -   **Stock Management:** Implemented a stock count for products, visible in the admin panel and to customers. Add to Cart is disabled for out-of-stock items.
    -   **Class Management:** Added fields for start/end dates, multiple class days, package deals, and add-ons. The public  was updated to display this new information.
    -   **Products on Home Page:** The home page now dynamically fetches and displays products from the API.
    -   **Configurable Taxes:** Replaced hardcoded tax with a dynamic system configurable via a new Tax tab in the admin panel.
    -   **Image Cropping:** Replaced all image upload fields with a new  component to allow cropping for products, classes, retreats, fundraisers, and services.
    -   **Customer Profile Pictures:** Users can now upload a profile picture from their dashboard.
    -   **Hidden/Draft Mode:** Added an Is Published toggle to Products, Classes, Retreats, and Fundraisers, allowing admins to hide content from public view. Public-facing APIs now filter out hidden items.
    -   **Contract Templates:** Enhanced the Contract Management system to allow admins to create, edit, and delete their own contract templates.
-   **Code Refactoring:**
    -   Deleted the unused  file.
    -   Migrated  from using  to fetching data from the API.

**Earlier issues found/mentioned but not fixed**
-   The **Resend API Key is Invalid** and is a recurring blocker. This is documented in the All Pending/In progress Issue list.

**Known issue recurrence from previous fork**
-   None.

**Code Architecture**


**Key Technical Concepts**
-   **Frontend:** React, Tailwind CSS, shadcn/ui, React Router, .
-   **Backend:** Python FastAPI, MongoDB (via ), Pydantic.
-   **Authentication:** JWT (, ).
-   **Payments:** Square API.

**key DB schema**
-   **ProductModel:** Added , .
-   **ClassModel:** Added , , , , , , , , .
-   **RetreatModel:** Added , .
-   **FundraiserModel:** Added .
-   **UserModel:** Added .
-   **New Collection:**  (stores ).
-   **New Collection:**  (stores ).
-   **SignedContractModel:** Added .

**changes in tech stack**
-   Added  and its dependencies (, ) to the frontend.

**All files of reference**
-   : Heavily modified to add all new models, endpoints, and logic for recent features.
-   : All components within this directory were modified to add new features (stock, hidden toggle, add-ons, image cropper).
-   : , , , , , , , ,  were all updated.
-   : New component for handling image uploads with cropping.
-   : New context for managing application-wide settings like taxes.
-   : New component for the tax management UI.
-   : New file to control mobile home screen appearance.

**Areas that need refactoring**:
-   The  component is now unused and should be deleted to avoid confusion.

**key api endpoints**
-    (GET, PUT): Manages tax rate and label.
-    (GET, POST, PUT, DELETE): Full CRUD for contract templates.
-   : Updated to handle  uploads.
-   , , ,  (GET): Updated to accept an  query parameter for fetching unpublished content in the admin panel.

**Critical Info for New Agent**
-   **Session Timeouts:** The preview environment is very aggressive with session timeouts. This makes multi-step UI testing via the screenshot tool extremely difficult. You will likely get logged out between steps. Prioritize API-level testing with  to verify backend logic, and be prepared for UI verification to be challenging. Do not get stuck in a login-screenshot loop.
-   **Resend API Key:** The user's Resend key is invalid. This is a hard blocker for any email-related features. You must get a new key from the user to proceed with email testing.
-   **Verify Before Building:** Before adding new features, it's critical to perform a quick UI verification of the last set of features (Image Cropping, Profile Pictures, Add-ons UI) as the previous agent was hampered by session timeouts. The code is there, but a visual check is needed.

**documents and test reports created in this job**
-   
-    (updated)

**Last 10 User Messages and any pending HUMAN messages**
1.  **User:** Requested a feature to add/delete contracts with templates. (Status: **RESOLVED**)
2.  **User:** Requested a feature to charge taxes on purchases. (Status: **RESOLVED**)
3.  **User:** Requested hidden/draft mode for content and add-ons for classes/retreats. (Status: **PARTIALLY RESOLVED** - UI for add-on selection in checkout is pending).
4.  **User:** Requested image cropping for all uploads and customer profile pictures. (Status: **RESOLVED**, but needs full UI verification).
5.  **User:** Clarified they couldn't see the stock count field in the *edit* product form. (Status: **USER VERIFICATION PENDING** - Agent confirmed it exists).
6.  **User:** Requested a stock count feature for products. (Status: **RESOLVED**)
7.  **User:** Requested that product/class/etc. descriptions preserve their formatting (line breaks) and that products automatically show up on the main page. (Status: **RESOLVED**)
8.  **User:** Requested enhancements for adding classes (instructor, price, description, date, package deals, multiple days). (Status: **RESOLVED**)
9.  **User:** Requested to change the home screen icon image. (Status: **RESOLVED**)
10. **Agent:** Finished fixing the initial three bugs (services not showing, wrong app icon/name). (Status: **RESOLVED**)

**Project Health Check:**
-   **Broken:** The Resend email integration is non-functional due to an invalid API key.
-   **Mocked:** None. All data is live.

**3rd Party Integrations**
-   **Square (Payments):** Integrated.
-   **Resend (Email):** Integrated but **BLOCKED** due to an invalid API key.
-   **react-image-crop:** New frontend library for image cropping.
-   **passlib[bcrypt]:** For password hashing.
-   **python-jose:** For JWT management.

**Testing status**
-   **Testing agent used after significant changes:** YES, for the initial batch of bug fixes.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None in this session.
-   **Known regressions:** None.

**Credentials to test flow:**
-   **Admin User:**
    -   **Email:** 
    -   **Password:** 

**What agent forgot to execute**
-   **Implement Add-on Selection in Checkout:** The agent created the backend and admin UI for add-ons for classes and retreats but did not implement the corresponding frontend logic for customers to select and pay for these add-ons during the enrollment or booking process.
-   **Delete Unused Component:** The old  component was replaced by  but was not deleted, leaving dead code in the repository.
-   **Full UI Verification:** Due to session timeout issues, the agent was unable to perform a complete, end-to-end visual verification of several new features (image cropping, profile picture upload, add-ons UI). The backend is confirmed working, but the frontend requires a final check.</analysis>
